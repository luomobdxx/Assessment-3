<div class="admin-container">
  <div class="events-header">
    <h2>Manage Events</h2>
    <div class="header-actions">
      <button class="pill" (click)="showAddForm()">Add Event</button>
    </div>
  </div>

  <table class="events-table" *ngIf="events.length > 0; else noData">
    <thead>
    <tr>
      <th>Name</th>
      <th>NGO</th>
      <th>Category</th>
      <th>Status</th>
      <th>Start</th>
      <th>End</th>
      <th>Location</th>
      <th>Ticket</th>
      <th>Progress</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let e of events">
      <td>{{ e.name }}</td>
      <td>{{ e.ngo_name || e.ngo_id }}</td>
      <td>{{ e.category }}</td>
      <td>{{ e.status }}</td>
      <td>{{ e.start_date | date:'short' }}</td>
      <td>{{ e.end_date ? (e.end_date | date:'short') : '-' }}</td>
      <td>{{ e.location }}</td>
      <td>{{ e.ticket_price | number:'1.2-2' }} {{ e.currency }}</td>
      <td>{{ e.progress_amount || 0 }} / {{ e.goal_amount || 0 }}</td>
      <td class="actions">
        <button class="pill edit-btn" (click)="showEditForm(e)">Edit</button>
        <button class="pill delete-btn" (click)="deleteEvent(e.event_id)">Delete</button>
      </td>
    </tr>
    </tbody>
  </table>

  <ng-template #noData>
    <div class="empty">No events found.</div>
  </ng-template>

  <!-- modal form -->
  <div class="modal" *ngIf="formVisible">
    <div class="modal-content">
      <h3>{{ formMode === 'add' ? 'Add Event' : 'Edit Event' }}</h3>

      <form [formGroup]="eventForm" (ngSubmit)="saveEvent()">
        <div class="form-row half">
          <div>
            <div>
              <label>NGO *</label>
              <select formControlName="ngo_id">
                <option value="">--- Select ---</option>
                <option *ngFor="let n of ngos" [value]="n.ngo_id">{{ n.ngo_name }}</option>
              </select>
            </div>
            <div class="error" *ngIf="hasError('ngo_id','required')">NGO is required.</div>
          </div>
          <div>
            <div>
              <label>Name *</label>
              <input type="text" formControlName="name" />
            </div>
            <div class="error" *ngIf="hasError('name','required')">Name is required.</div>
          </div>
        </div>
        <div class="form-row half">
          <div>
            <div>
              <label>Start Date *</label>
              <input type="datetime-local" formControlName="start_date" />
            </div>
            <div class="error" *ngIf="hasError('start_date','required')">Start date is required.</div>
          </div>
          <div>
            <div>
              <label>End Date</label>
              <input type="datetime-local" formControlName="end_date" />
            </div>
            <div class="error" *ngIf="eventForm.errors && eventForm.errors['dateRange']" style="margin-top:6px">{{ eventForm.errors['dateRange'] }}</div>
          </div>
        </div>

        <div class="form-row half">
          <div>
            <div>
              <label>Location</label>
              <input type="text" formControlName="location" />
            </div>
          </div>
          <div>
            <div>
              <label>Category</label>
              <input type="text" formControlName="category" />
            </div>
          </div>
        </div>

        <div class="form-row half">
          <div>
            <div>
              <label>Ticket Price</label>
              <input type="number" step="0.01" formControlName="ticket_price" />
            </div>
          </div>
          <div>
            <div>
              <label>Currency</label>
              <input type="text" formControlName="currency" />
            </div>
          </div>
        </div>

        <div class="form-row half">
          <div>
            <div>
              <label>Goal Amount</label>
              <input type="number" step="0.01" formControlName="goal_amount" />
            </div>
          </div>
          <div>
            <div>
              <label>Progress Amount</label>
              <input type="number" step="0.01" formControlName="progress_amount" />
            </div>
          </div>
        </div>

        <div class="form-row half">
          <div>
            <div>
              <label>Image URL</label>
              <input type="text" formControlName="image_url" />
            </div>
          </div>
          <div>
            <div>
              <label>Status</label>
              <select formControlName="status">
                <option value="draft">Draft</option>
                <option value="active">Active</option>
                <option value="suspended">Suspended</option>
                <option value="finished">Finished</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-row half">
          <div>
            <div>
              <label>Latitude</label>
              <input type="number" step="0.000001" formControlName="latitude" />
            </div>
            <div class="error" *ngIf="hasError('latitude','lat')">Latitude must be between -90 and 90.</div>
          </div>
          <div>
            <div>
              <label>Longitude</label>
              <input type="number" step="0.000001" formControlName="longitude" />
            </div>
            <div class="error" *ngIf="hasError('longitude','lng')">Longitude must be between -180 and 180.</div>
          </div>
        </div>

        <div class="form-row">
          <label>Full Description</label>
          <textarea formControlName="full_description" rows="4"></textarea>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div class="server-error" *ngIf="serverError">{{ serverError }}</div>
          <div class="modal-actions">
            <button type="submit" class="pill" [disabled]="saving">{{ saving ? 'Saving...' : 'Save' }}</button>
            <button type="button" class="pill muted" (click)="closeForm()">Cancel</button>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>
